<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= portefolje.navn %></title>
  <link href="/portefolje.css" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel="stylesheet">
</head>

<body>
  <!--Sidemenu navigation-->
  <div class="sidemenu">
    <div class="WebappLogo">
      <img src="/logo.jpeg" alt="WebappLogo">
    </div>

    <button class="pil" onclick="skiftMenu()"> 
      <i class='bx bxs-chevron-left'></i>
    </button>

    <ul class="menuValg">
      <li><a href="/dashboard"><i class='bx bx-home'></i>Dashboard</a></li>
      <li><a href="/konto/oversigt"><i class='bx bxs-user-account'></i>Konti</a></li>
      <li><a href="/portefolje/oversigt"><i class='bx bx-doughnut-chart'></i>Porteføljer</a></li>
      <li><a href="/indstillinger"><i class='bx bx-cog'></i>Indstillinger</a></li>
    </ul>

    <ul class="logUd">
      <li><a href="/login"><i class='bx bx-log-out'></i>Log ud</a></li>
    </ul>
  </div>

  <!-- Indhold -->
  <div class="indhold">

    <div class="overskrift">
      <h1><%= portefolje.navn %></h1>

      <!--søgefelt-->
      <form action="/portefolje/<%= portefolje.porteføljeID %>/searchPapir" method="GET" class="søgForm">
        <input type="text" name="query" placeholder="Søg efter navn på værdipapir" required>
        <button type="submit">Søg</button>
      </form>

      <!--Handelshistorik-knap-->
      <div class="tilføjKnapBox">
        <form action="/portefolje/<%= portefolje.porteføljeID %>/handelshistorik" method="GET" class="tilføjKnap">
          <button type="submit">Handelshistorik</button>
        </form>
      </div>
    </div>

    <!-- Øverste sektion -->
    <div class="øverste">
      <div class="grafboks">
        <h3>Samlet værdi</h3>
        <% if (værdipapirer.length > 0) { %>
          <p><%= samletVærdi.toLocaleString('da-DK', { style: 'currency', currency: 'DKK' }) %></p>
        <% } else { %>
          <p><em>Ingen værdipapirer i porteføljen endnu</em></p>
        <% } %>
      </div>

      <div class="højresideboks">
        <div class="diagramBoks">
          <h3>Fordeling af værdi</h3>
          <div id="pieChart" style="width: 100%; max-width: 900px; height: 900px; margin: auto;"></div>
        </div>
        <div class="højrenedreboks">
          <h3>Dato oprettet</h3>
          <p><%= new Date(portefolje.dato).toLocaleDateString('da-DK') %></p>
        </div>
      </div>
    </div>

    <!-- Oversigt over værdipapirer -->
    <div class="oversigtBox">
      <h3>Værdipapirer i portefølje</h3>
      <div class="listeOverskrifter">
        <span>Navn</span>
        <span>Type</span>
        <span>Symbol</span>
        <span>Antal</span>
        <span>Pris</span>
        <span>Værdi</span>
        <span>GAK</span>
      </div>

      <% if (værdipapirer.length > 0) { %>
        <% værdipapirer.forEach(p => { %> 
          <div class="aktieRække"> 
            <div><%= p.navn || 'Ukendt' %></div> 
            <div><%= p.type || 'Ukendt' %></div> 
            <div><%= p.tickerSymbol || 'Ukendt' %></div>
            <div><%= !isNaN(p.antal) ? p.antal : 'Ukendt' %></div>
            <div><%= !isNaN(p.pris) ? parseFloat(p.pris).toFixed(2) + ' DKK' : 'Ukendt' %></div>
            <%
            const antal = parseFloat(p.antal);
            const pris = parseFloat(p.pris);
            const værdi = !isNaN(antal) && !isNaN(pris) ? (antal * pris).toFixed(2) : null;
            %>
<div><%= værdi ? værdi + ' DKK' : 'Ukendt værdi' %></div>

            <div><%= p.GAK || 'Ukendt' %></div>
          </div>
        <% }) %>
      <% } else { %>
        <p><em>Ingen værdipapirer fundet endnu.</em></p>
      <% } %>
    </div> 

    <script>
      const sidemenu = document.querySelector('.sidemenu');
      function skiftMenu() {
        sidemenu.classList.toggle('lukket');
      }
    </script>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>
    const værdipapirer = <%- JSON.stringify(værdipapirer) %>;

    const labels = værdipapirer.map(p => p.navn || 'Ukendt');
    const series = værdipapirer.map(p =>
      !isNaN(p.pris) && !isNaN(p.antal) ? p.antal * p.pris : 0
    );

    const options = {
      chart: {
        type: 'pie',
        height: 1000,
      },
      series: series,
      labels: labels,
      title: {
        text: 'Fordeling af porteføljens værdi',
        align: 'center'
      },
      legend: {
        position: 'right',
        fontSize: '14px'
      },
      tooltip: {
        y: {
          formatter: function (val) {
            return val.toLocaleString('da-DK', { style: 'currency', currency: 'DKK' });
          }
        }
      },
      responsive: [{
        breakpoint: 768,
        options: {
          chart: {
            width: 320,
            height: 300
          },
          legend: {
            position: 'bottom'
          }
        }
      }]
    };

    const chart = new ApexCharts(document.querySelector("#pieChart"), options);
    chart.render();
  </script>
</body>
</html>
